// config          : GeminiConfig GPT4ALLConfig ChatGPTConfig
// llm_generation  : TaskProcessor ConversationManager models
// prompts         : PentestGPTPrompt
// scripts         : - 
// tasks           : crawl_page_sources  crawler.py  example_sqlmap.py  test_os_execution.py
// utils           : -

// main.py         : PentestGPTCLI


// from pentestgpt.utils.pentest_gpt import pentestGPT
//         pentest_handler = pentestGPT(**kwargs)
//         pentest_handler.main()


class PentestGPT {
    async inputHandler(): Promise<string | false> {
        /**
         * Request for user's input to:
         *  (1) input test results,
         *  (2) ask for todos,
         *  (3) input other information (discuss),
         *  (4) google.
         *  (5) end.
         * The design details are based on PentestGPT_design.md
         */

        this.chatCount += 1;

        const requestOption = mainTaskEntry();
        this.logConversation("user", requestOption);

        // always check if the session expires.
        if (!this.useAPI) {
            let conversationHistory = this.parsingAgent.getConversationHistory();
            while (conversationHistory === null) {
                await this.refreshSession();
                conversationHistory = this.parsingAgent.getConversationHistory();
            }
        }

        if (requestOption === "help") {
            console.log(new mainTaskCompleter().taskDetails);
        }

        if (requestOption === "next") {
            // (1) pass the information to input_parsing session.
            const options = Object.keys(this.postfixOptions);
            const optDesc = Object.values(this.optionsDesc);

            const valueList = options.map((opt, i) => ({
                index: i,
                label: `${opt} ${optDesc[i]}`
            }));

            const source = await promptSelect(
                "Please choose the source of the information.",
                valueList
            );

            console.log("Your input: (End with <shift + right-arrow>)");
            const userInput = await promptAsk("> ", { multiline: true });

            this.logConversation(
                "user",
                `Source: ${options[source]}\n${userInput}`
            );

            console.log("PentestGPT Thinking...");
            const parsedInput = await this.inputParsingHandler(
                userInput,
                options[source]
            );

            const reasoningResponse = await this.reasoningHandler(parsedInput);
            this.stepReasoningResponse = reasoningResponse;

            console.log(
                "Based on the analysis, the following tasks are recommended:"
            );
            console.log(reasoningResponse + "\n");

            this.logConversation(
                "pentestGPT",
                "Based on the analysis, the following tasks are recommended:" +
                reasoningResponse
            );

            return reasoningResponse;
        }

        if (requestOption === "more") {
            this.logConversation("user", "more");

            if (!this.stepReasoningResponse) {
                const msg =
                    "You have not initialized the task yet. Please perform the basic testing following `next` option.";
                console.error(msg);
                this.logConversation("pentestGPT", msg);
                return msg;
            }

            console.log(
                "PentestGPT will generate more test details, and enter the sub-task generation mode. (Press Enter to continue)"
            );
            this.logConversation(
                "pentestGPT",
                "PentestGPT will generate more test details, and enter the sub-task generation mode."
            );

            await promptAsk("", { multiline: false });

            console.log("PentestGPT Thinking...");
            const generationResponse = await this.testGenerationHandler(
                this.stepReasoningResponse
            );

            await this.testGenerationHandler(this.prompts.localTaskInit);

            console.log("Below are the further details.");
            console.log(generationResponse + "\n");

            this.logConversation("pentestGPT", generationResponse);

            while (true) {
                const localTaskResponse = await this.localInputHandler();
                if (localTaskResponse === "continue") break;
            }

            return generationResponse;
        }

        if (requestOption === "todo") {
            this.logConversation("user", "todo");

            console.log("PentestGPT Thinking...");
            const reasoningResponse = await this.reasoningHandler(
                this.prompts.askTodo
            );

            const message =
                this.prompts.todoToCommand + "\n" + reasoningResponse;

            const generationResponse = await this.testGenerationHandler(message);

            console.log(
                "Based on the analysis, the following tasks are recommended:"
            );
            console.log(reasoningResponse + "\n");

            console.log(
                "You can follow the instructions below to complete the tasks."
            );
            console.log(generationResponse + "\n");

            this.logConversation(
                "pentestGPT",
                `Based on the analysis, the following tasks are recommended:${reasoningResponse}
You can follow the instructions below to complete the tasks.${generationResponse}`
            );

            return reasoningResponse;
        }

        if (requestOption === "discuss") {
            console.log(
                "Please share your thoughts/questions with PentestGPT. (End with <shift + right-arrow>)"
            );
            this.logConversation(
                "pentestGPT",
                "Please share your thoughts/questions with PentestGPT."
            );

            const userInput = await promptAsk("Your input: ", {
                multiline: true
            });

            this.logConversation("user", userInput);

            console.log("PentestGPT Thinking...");
            const response = await this.reasoningHandler(
                this.prompts.discussion + userInput
            );

            console.log("PentestGPT:\n");
            console.log(response + "\n");

            this.logConversation("pentestGPT", response);
            return response;
        }

        if (requestOption === "google") {
            console.log(
                "Please enter your search query. PentestGPT will summarize the info from Google."
            );
            this.logConversation(
                "pentestGPT",
                "Please enter your search query. PentestGPT will summarize the info from Google."
            );

            const userInput = await promptAsk("Your input: ", {
                multiline: false
            });
            this.logConversation("user", userInput);

            console.log("PentestGPT Thinking...");
            const result = await googleSearch(userInput, 5);

            const response =
                "Google search results:\n" + "still under development.";

            console.log(response + "\n");
            this.logConversation("pentestGPT", response);
            return response;
        }

        if (requestOption === "quit") {
            console.log("Thank you for using PentestGPT!");
            this.logConversation("pentestGPT", "Thank you for using PentestGPT!");
            return false;
        }

        console.error("Please key in the correct options.");
        this.logConversation("pentestGPT", "Please key in the correct options.");
        return "Please key in the correct options.";

        
    }

    main = (): void => {
    }

}